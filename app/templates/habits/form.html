{% extends "base.html" %}
{% block title %}{{ 'Edit' if habit.id else 'Create' }} Habit · HabitFlow{% endblock %}
{% block content %}
<div class="card" style="max-width:900px;margin:auto">
  <h2 class="card-title">{{ 'Edit' if habit.id else 'Create' }} Habit</h2>

  <form method="post">
    <div class="row">
      <div>
        <label class="label" for="name">Name</label>
        <input class="input" id="name" name="name" value="{{ habit.name or '' }}" required />
      </div>

      <div>
        <label class="label" for="unit">Unit</label>
        <input class="input" id="unit" name="unit" value="{{ habit.unit or '' }}" />
      </div>
    </div>

    <div class="row">
      <div>
        <label class="label" for="kind">Type</label>
        <select class="select" id="kind" name="kind">
          {% for k in ['count','duration','distance','boolean'] %}
            <option value="{{ k }}" {{ 'selected' if habit.kind==k else '' }}>
              {{ {'count':'Count','duration':'Duration','distance':'Distance','boolean':'Boolean'}[k] }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label class="label" for="daily_target">Daily target (optional)</label>
        <input
          class="input"
          id="daily_target"
          name="daily_target"
          type="number"
          inputmode="decimal"
          value="{{ habit.daily_target if habit.daily_target is not none else '' }}"
        />
        <div class="label" id="target-hint" style="font-weight:500;color:var(--slate)"></div>
      </div>
    </div>

    <div>
      <label class="label" for="color">Color</label>
      <input class="input" id="color" name="color" type="color" value="{{ habit.color or '#3b82f6' }}" />
    </div>

    <div style="margin-top:16px;display:flex;gap:10px">
      <button class="btn btn-primary" type="submit">Save</button>
      <a class="btn btn-ghost" href="{{ url_for('habits.index') }}">Cancel</a>
    </div>
  </form>
</div>

<script>
  const kindSel   = document.getElementById('kind');
  const unitInput = document.getElementById('unit');
  const target    = document.getElementById('daily_target');
  const hint      = document.getElementById('target-hint');

  const defaults = {
    count:    { unit: 'reps', step: '1',   min: '0', placeholder: 'e.g. 30',   hint: 'Use whole numbers for counts.' },
    duration: { unit: 'min',  step: '1',   min: '0', placeholder: 'e.g. 20',   hint: 'Minutes per day.' },
    distance: { unit: 'km',   step: '0.1', min: '0', placeholder: 'e.g. 3.5',  hint: 'Kilometers per day (decimals allowed).' },
    boolean:  { unit: 'yes/no', step: 'any', min: '', placeholder: '',          hint: 'No numeric target for yes/no habits.' }
  };

  // if the user types into unit, we won’t auto-overwrite later
  unitInput.addEventListener('input', () => unitInput.dataset.touched = '1');

  function applyKind(initial=false) {
    const k = kindSel.value;

    // Update unit only if user hasn't typed a custom value
    const shouldSetUnit = !unitInput.dataset.touched || unitInput.value.trim() === '';
    if (shouldSetUnit) unitInput.value = defaults[k].unit;

    // Daily target behaviour
    if (k === 'boolean') {
      target.value = '';
      target.disabled = true;
      unitInput.disabled = true;
      target.removeAttribute('step');
      target.removeAttribute('min');
      target.placeholder = '';
    } else {
      target.disabled = false;
      unitInput.disabled = false;
      target.step = defaults[k].step;
      if (defaults[k].min) target.min = defaults[k].min; else target.removeAttribute('min');
      target.placeholder = defaults[k].placeholder;

      // For Count, keep it integer as the user types
      if (k === 'count') {
        target.addEventListener('input', hardIntEnforce);
      } else {
        target.removeEventListener('input', hardIntEnforce);
      }
    }
    hint.textContent = defaults[k].hint;

    // On initial load, mark unit as "touched" if it differs from our default
    if (initial && unitInput.value && unitInput.value !== defaults[k].unit) {
      unitInput.dataset.touched = '1';
    }
  }

  function hardIntEnforce() {
    if (target.value !== '') {
      const n = Math.max(0, Math.floor(Number(target.value)));
      target.value = isNaN(n) ? '' : String(n);
    }
  }

  document.addEventListener('DOMContentLoaded', () => applyKind(true));
  kindSel.addEventListener('change', () => applyKind());
</script>
{% endblock %}
